<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zpt.shop.main.mapper.OrderMapper">

	<!-- ********** ResultMap ********** -->
	<resultMap type="order" id="resultMap">
		<id property="id" column="id" />
		<result property="userId" column="userId" />
		<result property="address" column="address" />
		<result property="ordertime" column="ordertime" />
		<result property="logisticsnum" column="logisticsnum" />
		<result property="logistics" column="logistics" />
		<result property="state" column="state" />
		<result property="name" column="name" />
		<result property="phone" column="phone" />		
		<result property="totalPrice" column="totalPrice" />
		<result property="memo" column="memo" />
		<result property="ordernum" column="ordernum" />
		<collection property="orderDetail" column="orderDetail" ofType="OrderDetail">    
            <id property="id" column="OrderDetailId" />
            <result property="orderId" column="orderId" />
			<result property="skuId" column="skuId" />
			<result property="num" column="num" />
			<result property="price" column="price" />
			<result property="totalPrice" column="odtotalPrice" />
			<result property="name" column="odname" />
        </collection>	
	</resultMap>
	
	
	<sql id="queryCondition">
		where 1 = 1
		<if test="obj.logistics != null and obj.logistics != ''">
			and torder.logistics like CONCAT('%',#{obj.logistics},'%')
		</if>
		<if test="obj.logisticsnum != null and obj.logisticsnum != ''">
			and torder.logisticsnum like CONCAT('%',#{obj.logisticsnum},'%')
		</if>
		<if test="obj.ordernum != null and obj.ordernum != ''">
			and torder.ordernum like CONCAT('%',#{obj.ordernum},'%')
		</if>
		<if test="obj.state != null and obj.state != ''">
			and torder.state like CONCAT('%',#{obj.state},'%')
		</if>
		<if test="search != null and search != ''">
			and (torder.logistics like CONCAT('%',#{search},'%') or
				torder.logisticsnum like CONCAT('%',#{search},'%'))
		</if>
	</sql>
	
	<sql id="validateCondition">
		where 1 = 1
		<if test="id != null and id != ''">
			and id != #{id}
		</if>										
	</sql>	
		
	<select id="listOrder" resultMap="resultMap" parameterType="query">
		<include refid="com.zpt.shop.main.mapper.CommonMapper.beginSplitPage"/>
		select torder.id as id,torder.userId as userId,torder.address as address,torder.ordertime as ordertime,
		torder.logisticsnum as logisticsnum,torder.logistics as logistics,torder.state as state,
		torder.name as name,torder.phone as phone,goods.name as goodsName,torder.totalPrice as totalPrice,
		torder.memo as memo,torder.ordernum as ordernum
		from t_order as torder 
		left join t_user as tuser on torder.userId = tuser.id 
		left join t_order_detail as orderdetail on torder.id = orderdetail.orderId 
		left join t_goods_sku as sku on sku.id = orderdetail.skuId 
		left join t_goods as goods on sku.goodsid = goods.id		
		<include refid="queryCondition"/>
		<include refid="com.zpt.shop.main.mapper.CommonMapper.endSplitPage"/>
	</select>
	
	<select id="countOrder" resultType="java.lang.Integer" parameterType="query">
		select count(torder.id) from t_order as torder left join t_user as tuser on 
		torder.userId = tuser.id
		<include refid="queryCondition"/>
	</select>	
	
	<!-- 验证当前数据是否存在 -->
	<select id="validate" resultMap="resultMap" parameterType="order">
		select * from t_order
		<include refid="validateCondition"/>
	</select>
	
	<update id="updateState" parameterType="order">
		update t_order set state = #{state} where id = #{id}
	</update>
	
	<update id="seeOrder" parameterType="order">
		update t_order set memo = #{memo} where id = #{id}
	</update>
	
</mapper>
